Patient Volume – final spec & fixes
1) Scope (keep it simple)
We only record a single total per day (no departments).
Required fields: date, count, created_by (optional notes).
Only 3 users; keep flows lightweight.
2) API contract (one summary endpoint for the dashboard)
Create/confirm a single endpoint the dashboard will always call:
GET /api/patient-volume/summary?start=YYYY-MM-DD&end=YYYY-MM-DD
Returns: { total_count: number, days_reported: number, avg_per_day: number }
If there’s no data, return total_count: 0 (not null/undefined).
Keep existing:
POST /api/patient-volume → save one day’s count
GET /api/patient-volume/by-date?date=YYYY-MM-DD → used by the PV page list
3) Timezone & date handling (the current root cause)
Store dates as date-only (UTC midnight).
When reading a date from the UI, strip time and save as YYYY-MM-DD.
Dashboard should query by closed-open range:
start = first day of selected period
end = first day of next period
SQL should use entry_date >= start AND entry_date < end
Never compare exact timestamps (avoids the Safari/UTC offset pitfalls).
4) Dashboard KPI wiring (why it shows N/A now)
The KPI tile must always call the summary endpoint above when:
the dashboard mounts, and
the period filter changes.
Treat 0 as a valid value; only show “N/A” on true error.
Loading state: skeleton; Success: show total (e.g., “70 patients”); Error: small inline message.
5) Cache/refresh behavior
After saving a new entry on the Patient Volume page, invalidate/refresh the dashboard summary for that period.
Use one stable cache key: patient-volume:summary:{start}:{end}.
Avoid ad-hoc useEffect + fetch workarounds; keep it consistent with the other KPIs.
6) UI polish (both pages)
Executive Dashboard tile
Title: Patient Volume
Value: {total_count} patients
Subline: {avg_per_day} avg/day • {days_reported} days
Patient Volume page
Inputs: Date picker + “Patients seen” number.
Day list shows sum for that day.
Footer shows month total and avg/day for the selected month.
7) QA steps (must pass)
Enter 40 and 30 for the same day → PV page shows 70 total for that date.
Switch to Executive Dashboard (Current Month) → KPI shows 70, not “N/A”.
Change period → KPI updates to the new month.
Add another entry and return to dashboard → KPI auto-refreshes (no hard reload).
Network tab shows one call to /api/patient-volume/summary?start=…&end=… on mount and on period change.
If no entries this month → KPI shows 0 patients (not “N/A”).
8) Logging (temporary, remove after)
Log the exact start/end the dashboard sends.
Log the aggregated totals the server returns.
This will expose any remaining “N/A because query never ran” situations.
Optional (nice-to-have later)
Prevent duplicates for the same date by either:
allowing multiple entries but summing per day (current behavior), or
unique constraint per date and upsert.